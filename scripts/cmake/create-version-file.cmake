file(STRINGS ${CMAKE_SOURCE_DIR}/version.txt VERSION_CONTENTS)
list(GET VERSION_CONTENTS 0 FIRMWARE_MAJOR_VERSION)
list(GET VERSION_CONTENTS 1 FIRMWARE_MINOR_VERSION)
list(GET VERSION_CONTENTS 2 FIRMWARE_PATCH_VERSION)
list(GET VERSION_CONTENTS 3 FIRMWARE_SUFFIX)
set(FIRMWARE_VERSION ${FIRMWARE_MAJOR_VERSION}.${FIRMWARE_MINOR_VERSION}.${FIRMWARE_PATCH_VERSION})
message(STATUS "...Version (${PROJECT_NAME}): ${FIRMWARE_VERSION}...")

set(VERSION_FILE_TEMP ${CMAKE_BINARY_DIR}/version.h.tmp)
file(WRITE ${VERSION_FILE_TEMP} "// This file is automatically generated, do not edit manually\n")
file(APPEND ${VERSION_FILE_TEMP} "#include \"Arduino.h\"\n")
file(APPEND ${VERSION_FILE_TEMP} "const uint32_t mtMajor = ${FIRMWARE_MAJOR_VERSION};\n")
file(APPEND ${VERSION_FILE_TEMP} "const uint32_t mtMinor = ${FIRMWARE_MINOR_VERSION};\n")
file(APPEND ${VERSION_FILE_TEMP} "const uint32_t mtPatch = ${FIRMWARE_PATCH_VERSION};\n")
file(APPEND ${VERSION_FILE_TEMP} "const String mtSuffix = \"${FIRMWARE_SUFFIX}\";\n")
file(APPEND ${VERSION_FILE_TEMP} "const String mtVersion = \"${FIRMWARE_VERSION}\";\n")

set(VERSION_FILE_SOURCE_DIR ${CMAKE_SOURCE_DIR}/src)
set(VERSION_FILE_FINAL ${VERSION_FILE_SOURCE_DIR}/version.h)
set(UPDATE_VERSION_FILE 0)
if(EXISTS ${VERSION_FILE_FINAL})
    execute_process(
        COMMAND ${CMAKE_COMMAND} -E 
            compare_files ${VERSION_FILE_FINAL} ${VERSION_FILE_TEMP}
            RESULT_VARIABLE COMPARE_RESULT
    )
    if(COMPARE_RESULT EQUAL 0)
        message(STATUS "...Version not changed, so version file not updated...")
    elseif(COMPARE_RESULT EQUAL 1)
        message(STATUS "...Version changed, so version file updated...")
        set(UPDATE_VERSION_FILE 1)
    else()
        message(STATUS "...Could not determine if version changed, so version file not updated...")
    endif()
else()
    message(STATUS "...Version file created...")
    set(UPDATE_VERSION_FILE 1)
endif()

set(VERSION_FILE_TEMP_RENAMED ${CMAKE_BINARY_DIR}/version.h)
if(UPDATE_VERSION_FILE EQUAL 1)
    file(RENAME ${VERSION_FILE_TEMP} ${VERSION_FILE_TEMP_RENAMED})
    file(COPY ${VERSION_FILE_TEMP_RENAMED} DESTINATION ${VERSION_FILE_SOURCE_DIR})
endif()